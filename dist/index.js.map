{"version":3,"file":"index.js","sources":["../src/StorageService.ts","../src/createStorageHook.ts"],"sourcesContent":["/* eslint-disable no-underscore-dangle */\n/* eslint-disable no-useless-constructor */\nconst storageEventName = 'storage';\n\nconst defaultSerialize: Deserialize = text => {\n  if (text === null || text === undefined) {\n    return null;\n  }\n\n  try {\n    return JSON.parse(text);\n  } catch {\n    return null;\n  }\n};\n\nexport default class StorageService {\n  get deserialize() {\n    return this._deserialize;\n  }\n\n  get serialize() {\n    return this._serialize;\n  }\n\n  get storage() {\n    return this._storage;\n  }\n\n  constructor(\n    private _storage: Storage,\n    private _serialize: (o: unknown) => string = JSON.stringify,\n    private _deserialize: Deserialize = defaultSerialize,\n  ) {}\n\n  getData = <TData>(key: string) =>\n    this.deserialize<TData>(this.storage.getItem(key));\n\n  removeData = (key: string) => {\n    this.storage.removeItem(key);\n    this.raiseEvent({ key, newValue: '' });\n  };\n\n  setData = <TData>(key: string, data: TData) => {\n    const newValue = this.serialize(data);\n    this.storage.setItem(key, newValue);\n    this.raiseEvent({ key, newValue });\n  };\n\n  subscribe = (\n    handler: (event: {\n      storageArea: Storage | null;\n      key: string | null;\n      newValue: string | null;\n    }) => void,\n  ) => {\n    const listener = ({ storageArea, key, newValue }: StorageEvent) =>\n      handler?.({ storageArea, key, newValue });\n    window.addEventListener(storageEventName, listener);\n\n    return () => window.removeEventListener(storageEventName, listener);\n  };\n\n  private raiseEvent({ key, newValue }: { key: string; newValue: string }) {\n    window.dispatchEvent(\n      new StorageEvent(storageEventName, {\n        key,\n        newValue,\n        storageArea: this.storage,\n      }),\n    );\n  }\n}\n\nexport type Deserialize = <TData>(\n  text: string | null | undefined,\n) => TData | null;\n","import { useState, useCallback, SetStateAction, useEffect } from 'react';\nimport StorageService from './StorageService';\n\nconst createStorageHook = (storageService: StorageService) => {\n  const useStorage = <TValue>(\n    storageKey: string,\n    initialData: TValue | null = null,\n  ) => {\n    const [data, setData] = useState(\n      () => storageService.getData<TValue>(storageKey) || initialData,\n    );\n\n    const updateStorageData = useCallback(\n      (setStateAction: SetStateAction<TValue | null>) => {\n        setData(prevData => {\n          const newData =\n            setStateAction instanceof Function\n              ? setStateAction(prevData)\n              : setStateAction;\n          storageService.setData(storageKey, newData);\n          return newData;\n        });\n      },\n      [storageKey],\n    );\n\n    useEffect(() => {\n      const storageData = storageService.getData(storageKey);\n\n      if (\n        initialData !== undefined &&\n        initialData !== null &&\n        storageData === null\n      ) {\n        storageService.setData(storageKey, initialData);\n      }\n      // eslint-disable-next-line react-hooks/exhaustive-deps\n    }, [storageKey]);\n\n    useEffect(() => {\n      const unsubscribe = storageService.subscribe(\n        ({ key, newValue, storageArea }) => {\n          if (storageArea === storageService.storage && key === storageKey) {\n            setData(storageService.deserialize<TValue>(newValue));\n          }\n        },\n      );\n\n      return () => unsubscribe();\n    }, [storageKey]);\n\n    return [data, updateStorageData] as const;\n  };\n\n  return useStorage;\n};\n\nexport default createStorageHook;\n"],"names":["defaultSerialize","text","JSON","parse","_storage","_serialize","_deserialize","stringify","this","key","_this","deserialize","storage","getItem","removeItem","raiseEvent","newValue","data","serialize","setItem","handler","listener","storageArea","window","addEventListener","removeEventListener","dispatchEvent","StorageEvent","storageService","storageKey","initialData","useState","getData","setData","updateStorageData","useCallback","setStateAction","prevData","newData","Function","useEffect","storageData","unsubscribe","subscribe"],"mappings":"uBAIMA,EAAgC,SAAAC,GACpC,GAAIA,MAAAA,EACF,YAGF,IACE,OAAOC,KAAKC,MAAMF,GAClB,SACA,gDAiBF,WACUG,EACAC,EACAC,uBADAD,IAAAA,EAAqCH,KAAKK,oBAC1CD,IAAAA,EAA4BN,GAF5BQ,cAAAJ,EACAI,gBAAAH,EACAG,kBAAAF,EAGVE,aAAU,SAAQC,UAChBC,EAAKC,YAAmBD,EAAKE,QAAQC,QAAQJ,KAE/CD,gBAAa,SAACC,GACZC,EAAKE,QAAQE,WAAWL,GACxBC,EAAKK,WAAW,CAAEN,IAAAA,EAAKO,SAAU,MAGnCR,aAAU,SAAQC,EAAaQ,GAC7B,IAAMD,EAAWN,EAAKQ,UAAUD,GAChCP,EAAKE,QAAQO,QAAQV,EAAKO,GAC1BN,EAAKK,WAAW,CAAEN,IAAAA,EAAKO,SAAAA,KAGzBR,eAAY,SACVY,GAMA,IAAMC,EAAW,yBACfD,SAAAA,EAAU,CAAEE,cADMA,YACOb,MADMA,IACDO,WADMA,YAItC,OAFAO,OAAOC,iBAxDc,UAwDqBH,qBAE7BE,OAAOE,oBA1DC,UA0DqCJ,8BAGpDN,WAAA,YACNQ,OAAOG,cACL,IAAIC,aA/De,UA+DgB,CACjClB,MAHeA,IAIfO,WAJoBA,SAKpBM,YAAad,KAAKI,kDAlDtB,YAAYN,+CAIZ,YAAYD,2CAIZ,YAAYD,iOCvBU,SAACwB,GAmDzB,OAlDmB,SACjBC,EACAC,YAAAA,IAAAA,EAA6B,YAELC,WACtB,kBAAMH,EAAeI,QAAgBH,IAAeC,IAD/Cb,OAAMgB,OAIPC,EAAoBC,cACxB,SAACC,GACCH,EAAQ,SAAAI,GACN,IAAMC,EACJF,aAA0BG,SACtBH,EAAeC,GACfD,EAEN,OADAR,EAAeK,QAAQJ,EAAYS,GAC5BA,KAGX,CAACT,IA4BH,OAzBAW,YAAU,WACR,IAAMC,EAAcb,EAAeI,QAAQH,GAGzCC,MAAAA,GAEgB,OAAhBW,GAEAb,EAAeK,QAAQJ,EAAYC,IAGpC,CAACD,IAEJW,YAAU,WACR,IAAME,EAAcd,EAAee,UACjC,cAAkBrB,cACIM,EAAehB,WADlCH,MACqDoB,GACpDI,EAAQL,EAAejB,cAFnBK,aAOV,yBAAa0B,MACZ,CAACb,IAEG,CAACZ,EAAMiB"}